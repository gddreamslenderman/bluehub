-- FIXED Toggle Player Highlights (ESP) Script
-- Execute â†’ Highlights ALL players ON | Re-execute â†’ OFF (NOW ACTUALLY DISAPPEARS!)
-- Respawn-safe | Auto-recreates | Red enemies, Green teammates | Through walls!

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
_G.HighlightEnabled = _G.HighlightEnabled or false

-- Global storage
_G.Highlights = _G.Highlights or {}
_G.ESPConnection = _G.ESPConnection

-- Create/update highlight for a player
local function updateHighlight(plr)
    if plr == player then return end
    
    local char = plr.Character
    if not char or not char.Parent then return end
    
    -- Remove old if exists
    local oldHl = _G.Highlights[plr]
    if oldHl then oldHl:Destroy() end
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Parent = char
    highlight.Adornee = char
    highlight.FillTransparency = 1  -- Outline only
    highlight.OutlineTransparency = 0
    highlight.OutlineColor = Color3.new(1, 1, 1)  -- White default
    
    -- Team colors
    if plr.Team then
        if plr.Team == player.Team then
            highlight.OutlineColor = Color3.new(0, 1, 0)  -- Green teammate
        else
            highlight.OutlineColor = Color3.new(1, 0, 0)  -- Red enemy
        end
    end
    
    _G.Highlights[plr] = highlight
end

-- Toggle function (SIMPLE RUNSERVICE LOOP - foolproof!)
local function toggleHighlights()
    _G.HighlightEnabled = not _G.HighlightEnabled
    
    if _G.HighlightEnabled then
        print("ðŸŸ¢ Player Highlights: ON - All players ESP (fixed)!")
        
        -- Heartbeat loop: updates EVERY frame â†’ respawn-proof!
        _G.ESPConnection = RunService.Heartbeat:Connect(function()
            if not _G.HighlightEnabled then return end
            
            for _, plr in pairs(Players:GetPlayers()) do
                updateHighlight(plr)
            end
        end)
        
    else
        print("ðŸ”´ Player Highlights: OFF - All gone!")
        
        -- Stop loop
        if _G.ESPConnection then
            _G.ESPConnection:Disconnect()
            _G.ESPConnection = nil
        end
        
        -- DESTROY ALL highlights instantly (global table!)
        for plr, hl in pairs(_G.Highlights) do
            if hl and hl.Parent then
                hl:Destroy()
            end
        end
        _G.Highlights = {}
    end
end

-- Clean on player leave (always active)
Players.PlayerRemoving:Connect(function(plr)
    if _G.Highlights[plr] then
        _G.Highlights[plr]:Destroy()
        _G.Highlights[plr] = nil
    end
end)

-- Initial toggle
toggleHighlights()
